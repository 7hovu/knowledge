现在我有生产、调拨、配送计划，其中部分调拨量可以转为直发量，请根据以下输入数据及计算逻辑，输出调拨转直发的计划。及更新原有的调拨、配送计划为新的直发计划：


**输入数据：**

**生产计划**(production_plan)df中字段如下['sku_code', 'line_code', 'factory_code', 'period', 'production', 'production_plan_id', 'production_cost', 'period', 'doc_id']；

**调拨计划**（transfer_plan）df中字段如下['sku_code', 'send_stockorg_code', 'receive_stockorg_code', 'period', 'transfer_plan_id', 'transfer_cost', 'period', 'doc_id', 'transfer_qty', 'source_doc_id']；

**配送计划**(delivery_plan)df中字段如下：['sku_code','send_stockorg_code','receive_county_code','sales_area_code', 'period', 'delivery_plan_id', 'source_doc_id', 'delivery_qty', 'doc_id', 'period']

三个计划中，调拨计划是由工厂仓发至配送仓，source_doc_id为生产计划中的doc_id；配送计划是由配送仓配送至区县，如果配送仓就是工厂仓，这配送计划中的source_doc_id为生产计划中的doc_id；如果配送仓不为直接生产的工厂仓，则配送计划中的source_doc_id为调拨计划中doc_id。

  

**直发量计算逻辑：**

通过追溯的方式，计算每月工厂仓向区县的直发量，追溯的原则是“以最低成本实现直发”，对各个配送仓-月份独立执行以下步骤：

1. 如果该仓为工厂仓，且无其他仓调入，则本身即为直发，不必执行以下流程；
    
2. 取调入该仓的所有工厂仓，以及该仓配送的所有区县，生成工厂仓-区县笛卡尔积，得到所有可能的直发路径；
    
3. 计算每条路径的最大供应量 = SUM(MIN(工厂仓-产品-月调出量, 区县-产品-月配入量))；
    
4. 排除不可能直发的路径，满足以下任一条件：
    
    1. 最大供应量 ＜ 最小直发量；
        
    2. 最大供应量 ＜ 区县-产品-月配入量，即直发仓无法满足该产品的全部需求；
        
    3. 工厂仓-区县直发总成本 ＞ 工厂仓-主供仓-区县供应总成本；
        
    4. 不满足①喜力片区工厂仓，②主供仓跨片区和③近两年有配送记录三者之一的跨片区路径；
        
5. 从剩余路径中，选择物流成本最低的路径，计算直发量 = 最大供应量，匹配的产品即为直发产品；
    
6. 从路径集中剔除已计算直发量的路径，以及配送仓数量已经达到3个（可调参数）的区县；
    
7. 更新工厂仓-产品-月调出量和区县-产品-月配入量，各扣减直发量即可；
    
8. 回到第3步继续计算，直到路径集为空。